{% extends "layout.html" %}
{% block title %}{{title}}{% endblock %}

{% block content %}
<div class="container">

	<!-- Query Images -->
	<div class="row">
		{% if session.pos_idxs %}
		<div class="col-6">
			<div class="card">
				<div class="card-header text-center">
					Positive
				</div>
				<div class="card-body">
					<div class="row grid">	
						{% for idx in session.pos_idxs %}
						<div class="col-lg-2 col-md-4 col-sm-6 col-6 px-0 py-0 item" value="{{ idx }}" id="{{ idx }}" onclick="$(this).toggleClass('active');" onerror="$(this).hide();" ondblclick="$('.modal', this).modal('toggle');">
							<img style="width: 100%; height=auto" src="{{ session.get_url(idx) }}" />				
							<div class="modal fade" role="dialog" tabindex="-1" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-body justify-content-center">
											<a href="/source/{{ idx }}"><img style="width: 100%" src="/full/{{ idx }}" /></a>
										</div>
									</div>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		{% endif %}
		{% if session.neg_idxs %}
		<div class="col-6">
			<div class="card">
				<div class="card-header text-center">
					Negative
				</div>
				<div class="card-body">
					<div class="row grid">	
						{% for idx in session.neg_idxs %}
						<div class="col-lg-2 col-md-4 col-sm-6 col-6 px-0 py-0 item" value="{{ idx }}" id="{{ idx }}" onclick="$(this).toggleClass('active');" onerror="$(this).hide();" ondblclick="$('.modal', this).modal('toggle');">
							<img style="width: 100%; height=auto" src="{{ session.get_url(idx) }}" />				
							<div class="modal fade" role="dialog" tabindex="-1" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-body justify-content-center">
											<a href="/source/{{ idx }}"><img style="width: 100%" src="/full/{{ idx }}" /></a>
										</div>
									</div>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		{% endif %}
	</div>

	<!-- Controls -->

	<div class="card my-3">
		<form action="{{ url_for('interface') }}" method="POST" enctype="multipart/form-data">
			<div class="row py-3 gy-2 gx-2 mx-auto align-items-center justify-content-center">

				<select multiple hidden id="active" name="active"></select>

				<div class="col-auto">
					<select class="form-select" id="n" name="n" onchange="this.form.submit();" {{ 'disabled' if session.public }}>
						{% for n in Config.NS %}
						<option {{ 'selected' if session.n==n }} value="{{ n }}">{{n}}</option>
						{% endfor %}
					</select>
				</div>

				<div class="col-auto">
					<span class="form-text">of {{ session.model_len }} in</span>
				</div>

				<div class="col-auto">
					<select class="form-select" id="model" name="model" onchange="this.form.submit();">
						{% set  model_names = Config.MODEL_NAMES_PUBLIC if session.public else Config.MODEL_NAMES_PRIVATE + Config.MODEL_NAMES_PUBLIC %}
						{% for model in model_names %}
						<option {{ 'selected' if session.model==model }} value="{{ model }}">{{ model }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="col-auto">
					<button class="btn btn-light" type="submit" name="btn" value="Positive" onclick="set_active();">&#x2b;</button>
				</div>

				<div class="col-auto">
					<button class="btn btn-light" type="submit" name="btn" value="Negative" onclick="set_active();">&#8722;</button>
				</div>

				<div class="col-auto">
					<button class="btn btn-light" type="submit" name="btn" value="Remove" onclick="set_active();">Remove</button>
				</div>

				<div class="col-auto">
					<button class="btn btn-light" type="submit" name="btn" value="Clear">Clear</button>
				</div>
				
				{% if session.emb_type.startswith("clip"): %}
				<div class="col-auto">
					<input type="text" type="submit" class="form-control" id="clip_prompt" name="clip_prompt" placeholder="{{ session.clip_prompt if session.clip_prompt else 'CLIP Prompt' }}" />
				</div>

				<div class="col-auto">
					<button class="btn btn-light" type="submit" name="btn" value="Go">Go</button>
				</div>
				{% endif %}

				<div class="col-auto">
					<button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapse">...</button>
				</div>

			</div>

			<div class="collapse" id="collapse">
				<div class="row pb-3 gy-2 gx-2 mx-auto align-items-center justify-content-center">

					<div class="col-auto">
						<input class="form-control" type="file" name="file" />
					</div>

					<div class="col-auto">
						<button class="btn btn-light" type="file" onclick="this.form.submit()" {{ 'disabled' if session.public }}>Upload</button>
					</div>

					<div class="col-auto">
						<select class="form-select" id="emb_type" name="emb_type" onchange="this.form.submit();">
							{% for emb_type in session.emb_types %}
							<option {{ "selected" if session.emb_type==emb_type }} value="{{ emb_type }}">{{ emb_type }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-auto">
						<select class="form-select" id="metric" name="metric" onchange="this.form.submit();">
							{% for metric in session.metrics %}
							<option {{ "selected" if session.metric==metric }} value="{{ metric }}">{{ metric }}</option>
							{% endfor %}
						</select>
					</div>

				</div>
			</div>		
		</form>
	</div>

	<!-- Search results -->
	<div class="row grid">	
		{% for idx in session.res_idxs %}
		<div class="col-lg-1 col-md-2 col-sm-4 col-4 px-0 py-0 item" value="{{ idx }}" id="{{ idx }}" onclick="$(this).toggleClass('active');" onerror="this.hide();" ondblclick="$('.modal', this).modal('toggle');">
			<img style="width: 100%; height=auto" src="{{ session.get_url(idx) }}" />				
			<div class="modal fade" role="dialog" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-body justify-content-center">
							<a href="/source/{{ idx }}"><img style="width: 100%" src="/full/{{ idx }}" /></a>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>

</div>

<script>	

	$(".grid").imagesLoaded().progress( function() {
		console.log("Images loaded");
  		$(".grid").masonry({
			percentPosition: true})
	});
	
	function set_active() {
		$(".active").each( function() {
			value = $(this).attr("value");
			if (value != undefined){
				$("#active").append(new Option(value, value, false, true));
			}
		});
	};

</script>
{% endblock %}